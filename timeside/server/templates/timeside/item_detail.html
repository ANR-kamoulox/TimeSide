{% extends "timeside/base.html" %}
{% load i18n %}

{% block extra_stylesheets %}
{% endblock %}

{% block extra_javascript %}

<script type="text/javascript">
var d3 = wavesUI.d3;
var loader = new loaders.AudioBufferLoader();

var waveform = function(div_id) {

        // add waveform
        loader.load('download/ogg').then(function(audioBuffer) {
            try {
                var data = [{
                    start: audioBuffer.duration/4,
                    duration: audioBuffer.duration/2
                }];

                // 1. creat graph
                var graph = wavesUI.timeline()
                    .xDomain([0, audioBuffer.duration])
                    .width(1000)
                    .height(140);

                // 2. create layers
                var waveformLayer = wavesUI.waveform()
                    .data(audioBuffer.getChannelData(0).buffer)
                    .sampleRate(audioBuffer.sampleRate)
                    .color('purple')
                    // .opacity(0.8);

                var segmentLayer = wavesUI.segment()
                    .params({
                        interactions: { editable: true },
                        opacity: 0.4,
                        handlerOpacity: 0.6
                    })
                    .data(data)
                    .color('steelblue');

                // 3. add layers to graph
                graph.add(waveformLayer);
                graph.add(segmentLayer);

                // 4. draw graph
                d3.select('#'+div_id).call(graph.draw);
            } catch (err) {
                console.log(err);
            }
        }, function() {});
}


var timeline = function(json_url, div_id) {
    $.getJSON(json_url, function(data) {
        var duration = data[0].audio_metadata.duration;
        var durations = data[0].data_object.duration.numpyArray;
        var starts = data[0].data_object.time.numpyArray;
        var values = data[0].data_object.value.numpyArray;
        // format data
        var data = durations.map(function(dummy, index) {
            return {
                start: starts[index],
                duration: durations[index],
                height: values[index]
            };
        });

        // var minValue = Math.min.apply(null, values);
        var max_value = Math.max.apply(null, values);

        var graph = wavesUI.timeline()
                    .xDomain([0, duration])
                    .yDomain([0, max_value])
                    .width(1000)
                    .height(140);

        var segmentLayer = wavesUI.segment()
            .data(data)
            .color('steelblue')
            .opacity(0.8);

        // 3. add layers to graph
        graph.add(segmentLayer);

        // 4. draw graph
        d3.select('#'+div_id).call(graph.draw);

        var zoomLayer = wavesUI.zoomer()
            .select('#'+div_id)
            .on('mousemove', function(e) {
               // update graph xZoom
               graph.xZoom(e);
            })
            .on('mouseup', function(e) {
                // set the final xZoom value of the graph
                graph.xZoomSet();
            });

        // to update the data, add it to the data array and redraw the graph
        $('#add-data').on('click', function(e) {
            e.preventDefault();

            var datum = {
                start: 2,
                duration: 1,
                height: 1000
            };

            data.push(datum);
            graph.update();
        });

    });
}


$(window).ready(function() {

    waveform("waveform");

    $('.timeline').each( function (){
        var div_id = $(this).attr('id');
        var json_url = $(this).attr('json');
        timeline(json_url, div_id);
    });

});

</script>


{% endblock %}

{% block content %}

<h1>{{ object.title }}</h1>

{% block html5-player %}
 <audio controls>
  <source src="download/ogg" type="audio/ogg">
  <source src="download/mp3" type="audio/mpeg">
Your browser does not support the audio element.
</audio>
{% endblock html5-player %}

<div id="waveform"></div>

<ul>
   <li>File: {{ object.file }}</li>
   {% if object.url %}<li>url : {{ object.url }}</li>{% endif %}
   <li>mime_type : {{ object.mime_type }}</li>
   <li>sha1 : {{ object.sha1 }}</li>
   <li>hdf5 : {{ object.hdf5 }}</li>
   <li>uuid : {{ object.uuid }}</li>
   <li>author: {{ object.author }}</li>
   <li>lock : {{ object.lock }}</li>
</ul>

Results:

<ul>
{% for result in object.results.all %}
    <li>{{ result.preset.processor }} ({{ result.uuid }})
    {% if 'image' in result.mime_type %}
        <img src="{% url "timeside-result-png" result.id %}">
    {% elif 'audio' in result.mime_type %}
     <br>
     <audio controls>
        <source src="{% url "timeside-result-audio" result.id %}" type="{{Â result.mime_type }}">
     </audio>
    {% else %}
        <a href="{% url "timeside-result-json" result.id %}">JSON</a>
    {% endif %}

    {% if 'aubio_temporal' in result.preset.processor.pid %}
        <button id="add-data">add</button>
        <br>
        <div id="graph-{{ result.id }}" class="timeline" json="{% url "timeside-result-json" result.id %}"></div>
    {% endif %}

    </li>

{% endfor %}

<ul>

{% endblock content %}
